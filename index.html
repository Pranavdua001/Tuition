<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tuition App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial, sans-serif;background:#564100;margin:0;padding:20px;}
h2,h3{text-align:center;margin:2vh;margin-top:3vh;padding:0;color: #a02525;margin-bottom:3vh;}
.box{max-width:1000px;margin:auto;background:#ffd552;padding:20px;border-radius:10px;margin-bottom:20px;}
input,button,textarea{width:80%;margin-left:10%;padding:10px;margin-top:10px;border-radius:5px;border:1px solid #ccc;}
button,.innerbutton{background:#2563eb;color:#fff;border:none;cursor:pointer;margin-bottom: 2vh;}
button:hover{opacity:0.9;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#ffffff;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#f1f5f9;}
.innerbutton{margin-bottom:1vh;background:#2563ea}
.hidden{display:none;}
.paid{color:green;font-weight:bold;}
.unpaid{color:red;font-weight:bold;}
textarea{resize:none;}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h2>Tuition Login</h2>
  <input id="password" type="password" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<!-- TEACHER DASHBOARD -->
<div class="box hidden" id="teacherBox">
  <h2>Teacher Dashboard</h2>
  <button onclick="addStudent()">Add New Student</button>
  <button onclick="publishAll()">Publish All Students</button>
  <table id="teacherTable"></table>
</div>

<!-- STUDENT DASHBOARD -->
<div class="box hidden" id="studentBox">
  <h2>Student Dashboard</h2>
  <table id="studentTable"></table>
  <h3>Payment History</h3>
  <table id="studentHistoryTable"></table>
</div>

<script>
/* ================= SECURITY ================= */
const TEACHER_PASSWORD = "1234";
const ENCODE_KEY = 7;
const ENCODE_MULTIPLIER = 4;

/* ================= ENCODING ================= */
function encodeJSON(str){
  return Array.from(str).map(c => (c.charCodeAt(0)+ENCODE_KEY)*ENCODE_MULTIPLIER);
}
function decodeJSON(arr){
  return arr.map(n => String.fromCharCode((n/ENCODE_MULTIPLIER)-ENCODE_KEY)).join("");
}

/* ================= DATA ================= */
let teacherData = JSON.parse(localStorage.getItem("teacherData")) || { students:[] };
let loggedStudent = null;

/* ================= LOGIN ================= */
function login(){
  const pwd = document.getElementById("password").value;

  // Teacher login (local)
  if(pwd === TEACHER_PASSWORD){
    hide("loginBox");
    show("teacherBox");
    renderTeacher();
    return;
  }

  // Student login (remote / shared)
  fetch("students.json?v=" + Date.now())
    .then(r => {
      if(!r.ok) throw "no-data";
      return r.json();
    })
    .then(arr => {
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x => x.password === pwd);

      if(!s){
        alert("Invalid password");
        return;
      }

      loggedStudent = s.name;
      hide("loginBox");
      show("studentBox");
      renderStudent();
    })
    .catch(() => {
      alert("Student data not available. Ask teacher to publish.");
    });
}


/* ================= TEACHER FUNCTIONS ================= */
function addStudent(){
  const name = prompt("Enter student name:"); if(!name) return;
  const password = prompt("Enter student password:"); if(!password) return;
  const joiningdate = prompt("Enter joining date (YYYY-MM-DD):"); if(!joiningdate) return;
  const monthlyfees = Number(prompt("Enter monthly fees:")); if(isNaN(monthlyfees)) return;

  teacherData.students.push({
    name: name,
    password: password,
    joiningdate: joiningdate,
    monthlyfees: monthlyfees,
    feestobepaid: 0,
    feespaid: 0,
    feesremaining: 0,
    lastFeeCycle: -1,
    history: []
  });

  updateFeeCycles();
  save();
  renderTeacher();
}

function renderTeacher(){
  let html = `<tr>
    <th>Name</th><th>Password</th><th>Joining Date</th>
    <th>Montly Fees</th><th>Fees (to be paid)</th><th>Fees (Paid)</th><th>Fees (Remaining)</th><th>Status</th><th>Actions</th></tr>`;

  teacherData.students.forEach((s,i)=>{
    if(!s.history) s.history = []; // ensure history exists
    html += `<tr>
      <td>${s.name}</td>
      <td>${s.password}</td>
      <td>${s.joiningdate}</td>
      <td>₹${s.monthlyfees}</td>
      <td>₹${s.feestobepaid}</td>
      <td>₹${s.feespaid}</td>
      <td>₹${s.feestobepaid-s.feespaid}</td>
      <td class="${s.feespaid >= s.feestobepaid ? 'paid':'unpaid'}">${s.feespaid >= s.feestobepaid ? 'Paid':'Unpaid'}</td>
      <td>
        <button class="innerbutton" onclick="editfeestobepaid(${i})">Edit Fees ( to be paid )</button>
        <button class="innerbutton" onclick="editFees(${i})">Edit Fees Paid</button>
        <button class="innerbutton" onclick="viewHistory(${i})">History</button>
        <button class="innerbutton" onclick="delStudent(${i})">Delete</button>
      </td>
    </tr>`;
  });

  document.getElementById("teacherTable").innerHTML = html;
}

/* ----------- EDIT FEES TO BE PAID ----------- */
function editfeestobepaid(i){
  const s = teacherData.students[i];
  if(!s) return;
  if(!s.history) s.history = [];
  const monthlyfees = s.monthlyfees;
  let add = prompt(`Enter amount to be paid by ${s.name} (MonthlyFees: ₹${monthlyfees})`);
  if(add === null) return;
  add = Number(add);
  if(isNaN(add) || add<s.monthlyfees){ alert("Enter valid amount"); return;}
  if(add===s.monthlyfees+s.feesremaining){s.feespaid=0;s.feesremaining=add}
  s.feestobepaid = add;
s.history.push({
  date: new Date().toISOString().split("T")[0],
  type: "fee_due",
  amount: add
});  save();
  renderTeacher();
}

/* ----------- EDIT FEES ----------- */
function editFees(i){
  const s = teacherData.students[i];
  if(!s) return;
  if(!s.history) s.history = [];
  const remaining = s.feestobepaid - s.feespaid;
  let add = prompt(`Enter amount paid by ${s.name} (Remaining: ₹${remaining})`);
  if(add === null) return;
  add = Number(add);
  if(isNaN(add) || add<=0){ alert("Enter valid amount"); return;}
  if( s.feespaid + add > s.feestobepaid){ alert("Exceeds total fees"); return; }

  s.feespaid += add;
  s.feesremaining = s.feestobepaid - s.feespaid;
s.history.push({
  date: new Date().toISOString().split("T")[0],
  type: "payment",
  amount: add
});  save();
  renderTeacher();
}

/* ----------- VIEW HISTORY ----------- */
function viewHistory(i){
  const s = teacherData.students[i];
  if(!s){ alert("Student not found"); return; }
  if(!s.history || s.history.length === 0){
    alert("No history available.");
    return;
  }

  let h = `History for ${s.name}:\n\n`;

  s.history.forEach((p, j) => {
    let text = "";

    if(p.type === "fee_due") text = "Fees (to be paid)";
    else if(p.type === "payment") text = "Fees (paid)";
    else return; // ignore other types if any

    h += `${j+1}. ${p.date} - ₹${p.amount} - ${text}\n`;
  });

  alert(h);
}


/* ----------- DELETE STUDENT ----------- */
function delStudent(i){
  const s = teacherData.students[i];
  if(!s) return;
  if(!confirm(`Delete student ${s.name}?`)) return;
  teacherData.students.splice(i,1);
  save();
  renderTeacher();
}

/* ----------- PUBLISH ALL STUDENTS ----------- */
function publishAll(){
  updateFeeCycles();
  const encoded = encodeJSON(JSON.stringify(teacherData.students));
  const blob = new Blob([JSON.stringify(encoded)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "students.json";
  a.click();
  alert("students.json downloaded — can be uploaded or shared");
}

/* ================= STUDENT DASHBOARD ================= */
function renderStudent(){
  fetch("students.json")
    .then(r=>r.json())
    .then(arr=>{
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x=>x.name===loggedStudent);
      if(!s) throw 0;
      if(!s.history) s.history = [];

      document.getElementById("studentTable").innerHTML = `
        <tr><th>Name</th><td>${s.name}</td></tr>
        <tr><th>Joining Date</th><td>${s.joiningdate}</td></tr>
        <tr><th>Monthly Fees</th><td>₹${s.monthlyfees}</td></tr>
        <tr><th>Fees (to be Paid)</th><td>₹${s.feestobepaid}</td></tr>
        <tr><th>Fees (Paid)</th><td>₹${s.feespaid}</td></tr>
        <tr><th>Fees (Remaining)</th><td>₹${s.feestobepaid-s.feespaid}</td></tr>
        <tr><th>Status</th><td class="${s.feespaid>=s.feestobepaid?'paid':'unpaid'}">${s.feespaid>=s.feestobepaid?'Paid':'Unpaid'}</td></tr>
      `;

      // Payment history table
      let historyHTML = `<tr><th>#</th><th>Date</th><th>Fees (to be Paid)</th><th>Fees (Paid)</th></tr>`;
      if(s.history.length===0){
        historyHTML += `<tr><td colspan="4">No payments yet</td></tr>`;
      } else {
        s.history.forEach((p,j)=>{
          historyHTML += `<tr><td>${j+1}</td><td>${p.date}</td><td>${p.type === "fee_due" ? "₹" + p.amount : ""}</td>
        <td>${p.type === "payment" ? "₹" + p.amount : ""}</td></tr>`;
        });
      }
      document.getElementById("studentHistoryTable").innerHTML = historyHTML;
    })
    .catch(()=> document.getElementById("studentTable").innerHTML="No data published yet");
}
function updateFeeCycles(){
  const today = new Date();

  teacherData.students.forEach(s => {
    s.history ??= [];
    s.lastFeeCycle ??= -1;
    s.feestobepaid ??= 0;
    s.feespaid ??= 0;

    const joining = new Date(s.joiningdate);

    let monthsPassed =
      (today.getFullYear() - joining.getFullYear()) * 12 +
      (today.getMonth() - joining.getMonth());

    if (today.getDate() < joining.getDate()) monthsPassed--;
    if (monthsPassed < 0) return;

    if (monthsPassed > s.lastFeeCycle) {
      const overdue = s.feestobepaid - s.feespaid;

      s.feespaid = 0;
      s.feestobepaid = overdue + s.monthlyfees;
      s.feesremaining = s.feestobepaid;
      s.lastFeeCycle = monthsPassed;

      // ONLY fee_due history entry
      s.history.push({
        date: today.toISOString().split("T")[0],
        type: "fee_due",
        amount: s.feestobepaid
      });
    }
  });
}


/* ================= LOCAL STORAGE ================= */
function save(){ localStorage.setItem("teacherData",JSON.stringify(teacherData)); }

/* ================= HELPERS ================= */
function hide(id){document.getElementById(id).classList.add("hidden")}
function show(id){document.getElementById(id).classList.remove("hidden")}

</script>
</body>
</html>
