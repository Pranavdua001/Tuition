<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Offline Tuition App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.box{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px;
box-shadow:0 10px 25px rgba(0,0,0,.1);margin-bottom:20px}
h2,h3{text-align:center}
input,button{width:100%;padding:10px;margin-top:10px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;margin-top:15px;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f1f5f9}
.hidden{display:none}
.paid{color:green;font-weight:bold}
.unpaid{color:red;font-weight:bold}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="password" type="password" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<!-- TEACHER -->
<div class="box hidden" id="teacherBox">
  <h3>Teacher Dashboard</h3>
  <button onclick="addStudent()">Add Student</button>
  <button onclick="publishAll()">Publish All Students</button>
  <table id="teacherTable"></table>
</div>

<!-- STUDENT -->
<div class="box hidden" id="studentBox">
  <h3>Student Dashboard</h3>
  <table id="studentTable"></table>
</div>

<script>
/* ================= CONFIG ================= */
const TEACHER_PASSWORD = "1234";
const ENCODE_KEY = 7;
const ENCODE_MULTIPLIER = 4;

/* ================= ENCODE / DECODE ================= */
function encodeJSON(str){
  return Array.from(str).map(c => (c.charCodeAt(0)+ENCODE_KEY)*ENCODE_MULTIPLIER);
}
function decodeJSON(arr){
  return arr.map(n => String.fromCharCode((n/ENCODE_MULTIPLIER)-ENCODE_KEY)).join("");
}

/* ================= DATA ================= */
let teacherData = JSON.parse(localStorage.getItem("teacherData")) || { students:[] };
let loggedStudent = null;

/* ================= LOGIN ================= */
function login(){
  const pwd = document.getElementById("password").value;

  if(pwd === TEACHER_PASSWORD){
    hide("loginBox"); show("teacherBox");
    renderTeacher(); return;
  }

  const s = teacherData.students.find(x => x.password === pwd);
  if(s){
    loggedStudent = s.name;
    hide("loginBox"); show("studentBox");
    renderStudent(); return;
  }

  alert("Invalid password");
}

/* ================= MONTH RESET ================= */
function resetFeesIfNewMonth(s){
  const join = new Date(s.joiningdate);
  const now = new Date();

  const monthGap =
    (now.getFullYear() - join.getFullYear()) * 12 +
    (now.getMonth() - join.getMonth());

  if(monthGap >= 1 && s.lastResetMonth !== now.getMonth()){
    s.monthlyfeespaid = 0;
    s.lastResetMonth = now.getMonth();
  }
}

/* ================= TEACHER ================= */
function addStudent(){
  const name = prompt("Student name:");
  const password = prompt("Student password:");
  const joiningdate = prompt("Joining date (YYYY-MM-DD):");
  const monthlyfees = prompt("Monthly fees:");

  if(!name || !password || !joiningdate || !monthlyfees) return;

  teacherData.students.push({
    name,
    password,
    joiningdate,
    monthlyfees: Number(monthlyfees),
    monthlyfeespaid: 0,
    lastResetMonth: new Date(joiningdate).getMonth()
  });

  save(); renderTeacher();
}

function renderTeacher(){
  let h = `<tr>
    <th>Name</th><th>Password</th><th>Joining</th>
    <th>Total</th><th>Paid</th><th>Remaining</th><th>Status</th><th>Actions</th>
  </tr>`;

  teacherData.students.forEach((s,i)=>{
    resetFeesIfNewMonth(s);
    const remaining = s.monthlyfees - s.monthlyfeespaid;
    const paid = remaining === 0;

    h += `<tr>
      <td>${s.name}</td>
      <td>${s.password}</td>
      <td>${s.joiningdate}</td>
      <td>₹${s.monthlyfees}</td>
      <td>₹${s.monthlyfeespaid}</td>
      <td>₹${remaining}</td>
      <td class="${paid?'paid':'unpaid'}">${paid?'Paid':'Unpaid'}</td>
      <td>
        <button onclick="att(${i})">Edit Fees</button>
        <button onclick="del(${i})">Delete</button>
      </td>
    </tr>`;
  });

  save();
  document.getElementById("teacherTable").innerHTML = h;
}

function att(i){
  const s = teacherData.students[i];
  resetFeesIfNewMonth(s);

  let add = prompt(
    `Enter amount paid by ${s.name}\nRemaining: ₹${s.monthlyfees - s.monthlyfeespaid}`
  );
  if(add === null) return;

  add = Number(add);
  if(isNaN(add) || add <= 0){
    alert("Invalid amount"); return;
  }

  if(s.monthlyfeespaid + add > s.monthlyfees){
    alert("Exceeds monthly fees"); return;
  }

  s.monthlyfeespaid += add;
  save(); renderTeacher();
}

function del(i){
  if(!confirm("Delete this student permanently?")) return;
  teacherData.students.splice(i,1);
  save(); renderTeacher();
}

/* ================= PUBLISH ================= */
function publishAll(){
  const encoded = encodeJSON(JSON.stringify(teacherData.students));
  const blob = new Blob([JSON.stringify(encoded)],{type:"application/json"});
  download(blob,"students.json");
  alert("students.json downloaded. Upload to GitHub.");
}

function save(){
  localStorage.setItem("teacherData",JSON.stringify(teacherData));
}

/* ================= STUDENT ================= */
function renderStudent(){
  fetch("students.json")
    .then(r=>r.json())
    .then(arr=>{
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x=>x.name===loggedStudent);
      if(!s) throw 0;

      const remaining = s.monthlyfees - s.monthlyfeespaid;
      const paid = remaining === 0;

      document.getElementById("studentTable").innerHTML = `
        <tr><th>Name</th><td>${s.name}</td></tr>
        <tr><th>Joining</th><td>${s.joiningdate}</td></tr>
        <tr><th>Total Fees</th><td>₹${s.monthlyfees}</td></tr>
        <tr><th>Paid</th><td>₹${s.monthlyfeespaid}</td></tr>
        <tr><th>Remaining</th><td>₹${remaining}</td></tr>
        <tr><th>Status</th>
            <td class="${paid?'paid':'unpaid'}">${paid?'Paid':'Unpaid'}</td></tr>
      `;
    })
    .catch(()=>{
      document.getElementById("studentTable").innerHTML =
        "No published data available";
    });
}
/* ================= HELPERS ================= */
function hide(id){document.getElementById(id).classList.add("hidden")}
function show(id){document.getElementById(id).classList.remove("hidden")}
function download(blob,name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name; a.click();
}
</script>
</body>
</html>
