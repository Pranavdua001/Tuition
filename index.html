<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Tuition Fee System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.box{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
h2,h3{text-align:center}
input,button{width:100%;padding:10px;margin-top:10px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f1f5f9}
.hidden{display:none}
.paid{color:green;font-weight:bold}
.unpaid{color:red;font-weight:bold}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h2>Tuition Login</h2>
  <input id="password" type="password" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<!-- TEACHER -->
<div class="box hidden" id="teacherBox">
  <h2>Teacher Dashboard</h2>
  <button onclick="addStudent()">Add Student</button>
  <button onclick="publishAll()">Publish</button>
  <table id="teacherTable"></table>
</div>

<!-- STUDENT -->
<div class="box hidden" id="studentBox">
  <h2>Student Dashboard</h2>
  <table id="studentTable"></table>
  <h3>Payment History</h3>
  <table id="studentHistoryTable"></table>
</div>

<script>
/* ========= CONFIG ========= */
const TEACHER_PASSWORD = "1234";
const KEY = 7, MUL = 4;

/* ========= HELPERS ========= */
function hide(id){document.getElementById(id).classList.add("hidden")}
function show(id){document.getElementById(id).classList.remove("hidden")}

function encodeJSON(str){
  return Array.from(str).map(c => (c.charCodeAt(0)+KEY)*MUL);
}
function decodeJSON(arr){
  return arr.map(n => String.fromCharCode(n/MUL-KEY)).join("");
}

/* ========= DATA ========= */
let teacherData = JSON.parse(localStorage.getItem("teacherData")) || {students:[]};
let loggedStudent = null;

/* ========= DATE / BILLING LOGIC ========= */
function completedCycles(joinDate){
  const today = new Date();
  const join = new Date(joinDate);
  let m = (today.getFullYear()-join.getFullYear())*12 + (today.getMonth()-join.getMonth());
  if(today.getDate() < join.getDate()) m--;
  return Math.max(0,m);
}

function totalPaid(payments){
  return payments.reduce((s,p)=>s+p.amount,0);
}

function totalFeeTillNow(student){
  return (completedCycles(student.joiningdate)+1) * student.monthlyfee;
}

function dueAmount(student){
  return Math.max(0, totalFeeTillNow(student) - totalPaid(student.payments));
}

/* ========= LOGIN ========= */
function login(){
  const pwd = password.value;

  if(pwd === TEACHER_PASSWORD){
    hide("loginBox"); show("teacherBox"); renderTeacher(); return;
  }

  fetch("students.json?v="+Date.now())
    .then(r=>r.json())
    .then(arr=>{
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x=>x.password===pwd);
      if(!s) return alert("Invalid password");
      loggedStudent = s.name;
      hide("loginBox"); show("studentBox");
      renderStudent();
    })
    .catch(()=>alert("Student data not available"));
}

/* ========= TEACHER ========= */
function addStudent(){
  const name = prompt("Name");
  const password = prompt("Password");
  const joiningdate = prompt("Joining Date (YYYY-MM-DD)");
  const monthlyfee = Number(prompt("Monthly Fee"));
  if(!name||!password||!joiningdate||!monthlyfee) return;

  teacherData.students.push({
    name,password,joiningdate,monthlyfee,
    payments:[]
  });
  save(); renderTeacher();
}

function renderTeacher(){
  let html=`<tr>
    <th>Name</th><th>Join</th><th>Monthly</th>
    <th>Total Fees</th><th>Paid</th><th>Due</th><th>Status</th><th>Action</th>
  </tr>`;

  teacherData.students.forEach((s,i)=>{
    const total = totalFeeTillNow(s);
    const paid = totalPaid(s.payments);
    const due = dueAmount(s);
    html+=`<tr>
      <td>${s.name}</td>
      <td>${s.joiningdate}</td>
      <td>₹${s.monthlyfee}</td>
      <td>₹${total}</td>
      <td>₹${paid}</td>
      <td>₹${due}</td>
      <td class="${due===0?'paid':'unpaid'}">${due===0?'Paid':'Unpaid'}</td>
      <td><button onclick="pay(${i})">Add Payment</button></td>
    </tr>`;
  });
  teacherTable.innerHTML = html;
}

function pay(i){
  const amt = Number(prompt("Amount paid"));
  if(!amt) return;
  teacherData.students[i].payments.push({
    date:new Date().toISOString().split("T")[0],
    amount:amt
  });
  save(); renderTeacher();
}

function publishAll(){
  const enc = encodeJSON(JSON.stringify(teacherData.students));
  const blob = new Blob([JSON.stringify(enc)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "students.json";
  a.click();
}

/* ========= STUDENT ========= */
function renderStudent(){
  fetch("students.json")
    .then(r=>r.json())
    .then(arr=>{
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x=>x.name===loggedStudent);

      const total = totalFeeTillNow(s);
      const paid = totalPaid(s.payments);
      const due = dueAmount(s);

      studentTable.innerHTML=`
        <tr><th>Name</th><td>${s.name}</td></tr>
        <tr><th>Joining</th><td>${s.joiningdate}</td></tr>
        <tr><th>Monthly Fee</th><td>₹${s.monthlyfee}</td></tr>
        <tr><th>Total Fees</th><td>₹${total}</td></tr>
        <tr><th>Paid</th><td>₹${paid}</td></tr>
        <tr><th>Due</th><td>₹${due}</td></tr>
        <tr><th>Status</th><td class="${due===0?'paid':'unpaid'}">${due===0?'Paid':'Unpaid'}</td></tr>
      `;

      let h=`<tr><th>#</th><th>Date</th><th>Amount</th></tr>`;
      if(!s.payments.length) h+=`<tr><td colspan=3>No payments</td></tr>`;
      s.payments.forEach((p,i)=>{
        h+=`<tr><td>${i+1}</td><td>${p.date}</td><td>₹${p.amount}</td></tr>`;
      });
      studentHistoryTable.innerHTML=h;
    });
}

/* ========= STORAGE ========= */
function save(){
  localStorage.setItem("teacherData",JSON.stringify(teacherData));
}
</script>

</body>
</html>


