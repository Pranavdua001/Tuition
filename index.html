<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Offline Tuition App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.box{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.1);margin-bottom:20px}
h2,h3{text-align:center}
input,button{width:100%;padding:10px;margin-top:10px}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
table{width:100%;margin-top:15px;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#f1f5f9}
.hidden{display:none}
.paid{color:green;font-weight:bold}
.unpaid{color:red;font-weight:bold}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="password" type="password" placeholder="Enter password">
  <button onclick="login()">Login</button>
</div>

<!-- TEACHER -->
<div class="box hidden" id="teacherBox">
  <h3>Teacher Dashboard</h3>
  <button onclick="addStudent()">Add Student</button>
  <button onclick="publishAll()">Publish All Students</button>
  <table id="teacherTable"></table>
</div>

<!-- STUDENT -->
<div class="box hidden" id="studentBox">
  <h3>Student Dashboard</h3>
  <table id="studentTable"></table>
</div>

<script>
/* ================= SECURITY ================= */
const TEACHER_PASSWORD = "1234";
const ENCODE_KEY = 7;
const ENCODE_MULTIPLIER = 4;

/* ================= ENCODING ================= */
function encodeJSON(str){
  return Array.from(str).map(c => (c.charCodeAt(0)+ENCODE_KEY)*ENCODE_MULTIPLIER);
}
function decodeJSON(arr){
  return arr.map(n => String.fromCharCode((n/ENCODE_MULTIPLIER)-ENCODE_KEY)).join("");
}

/* ================= DATA ================= */
let teacherData = JSON.parse(localStorage.getItem("teacherData")) || { students:[] };
let loggedStudent = null;

/* ================= LOGIN ================= */
function login(){
  const pwd = document.getElementById("password").value;

  if(pwd === TEACHER_PASSWORD){
    hide("loginBox"); show("teacherBox"); updateFeeCycles(); renderTeacher(); return;
  }

  const s = teacherData.students.find(x => x.password === pwd);
  if(s){
    loggedStudent = s.name;
    hide("loginBox"); show("studentBox"); updateFeeCycles(); renderStudent(); return;
  }

  alert("Invalid password");
}

/* ================= TEACHER ================= */
function addStudent(){
  const name = prompt("Student name:");
  const password = prompt("Student password:");
  const joiningdate = prompt("Joining date (YYYY-MM-DD):");
  const monthlyfees = Number(prompt("Student monthly fees:"));
  if(!name || !password || !joiningdate || isNaN(monthlyfees)) return;

  teacherData.students.push({
    name,
    password,
    joiningdate,
    monthlyfees,
    monthlyfeespaid: 0,
    lastFeeCycle: 0,
    history: [] // store each month's payment
  });

  save(); renderTeacher();
}

function renderTeacher(){
  let h = `<tr>
    <th>Name</th><th>Password</th><th>JoiningDate</th>
    <th>Fees(Total)</th><th>Fees(Paid)</th><th>Status</th>
    <th>History</th>
    <th>Actions</th></tr>`;

  teacherData.students.forEach((s,i)=>{
    const status = s.monthlyfeespaid >= s.monthlyfees ? 'Paid':'Unpaid';
    h += `<tr>
      <td>${s.name}</td>
      <td>${s.password}</td>
      <td>${s.joiningdate}</td>
      <td>₹${s.monthlyfees}</td>
      <td>₹${s.monthlyfeespaid}</td>
      <td class="${status.toLowerCase()}">${status}</td>
      <td>${s.history.map(h=>`[${h.month}]: ₹${h.paid}`).join("<br>")}</td>
      <td>
        <button onclick="att(${i})">Edit Fees Paid</button>
        <button onclick="del(${i})">Delete data</button>
      </td>
    </tr>`;
  });

  document.getElementById("teacherTable").innerHTML = h;
}

function att(i){
  let s = teacherData.students[i];
  let add = prompt(`Enter amount paid by ${s.name}\nRemaining: ₹${s.monthlyfees - s.monthlyfeespaid}`);
  if(add === null) return;
  add = Number(add);
  if(isNaN(add) || add <=0){ alert("Enter valid amount"); return; }
  if(s.monthlyfeespaid + add > s.monthlyfees){ alert("Amount exceeds total fees"); return; }
  s.monthlyfeespaid += add;

  // add/update history for this month
  const today = new Date();
  const jd = new Date(s.joiningdate);
  let monthsPassed = (today.getFullYear()-jd.getFullYear())*12 + (today.getMonth()-jd.getMonth());
  if(today.getDate() < jd.getDate()) monthsPassed--;
  const monthStr = `${today.getFullYear()}-${today.getMonth()+1}`;
  const histIndex = s.history.findIndex(h=>h.month===monthStr);
  if(histIndex>=0) s.history[histIndex].paid = s.monthlyfeespaid;
  else s.history.push({month:monthStr, paid:s.monthlyfeespaid});

  save(); renderTeacher();
}

function del(i){
  if(!confirm("Delete this student?")) return;
  teacherData.students.splice(i,1);
  save(); renderTeacher();
}

function publishAll(){
  const encoded = encodeJSON(JSON.stringify(teacherData.students));
  const blob = new Blob([JSON.stringify(encoded)],{type:"application/json"});
  download(blob,"students.json");
  alert("students.json downloaded — upload to GitHub repo");
}

function save(){ localStorage.setItem("teacherData",JSON.stringify(teacherData)); }

/* ================= STUDENT ================= */
function renderStudent(){
  fetch("students.json")
    .then(r=>r.json())
    .then(arr=>{
      const students = JSON.parse(decodeJSON(arr));
      const s = students.find(x=>x.name===loggedStudent);
      if(!s) throw 0;
      const status = s.monthlyfeespaid >= s.monthlyfees ? 'Paid':'Unpaid';
      document.getElementById("studentTable").innerHTML=`<tr>
        <th>Name</th><td>${s.name}</td></tr>
        <tr><th>JoiningDate</th><td>${s.joiningdate}</td></tr>
        <tr><th>monthlyfees</th><td>₹${s.monthlyfees}</td></tr>
        <tr><th>Status</th><td class="${status.toLowerCase()}">${status}</td></tr>
        <tr><th>History</th><td>${s.history.map(h=>`[${h.month}]: ₹${h.paid}`).join("<br>")}</td></tr>`;
    })
    .catch(()=>document.getElementById("studentTable").innerHTML="No published data yet");
}

/* ================= FEE CYCLE ================= */
function updateFeeCycles(){
  const today = new Date();
  teacherData.students.forEach(s=>{
    const jd = new Date(s.joiningdate);
    let monthsPassed = (today.getFullYear()-jd.getFullYear())*12 + (today.getMonth()-jd.getMonth());
    if(today.getDate() < jd.getDate()) monthsPassed--;
    if(monthsPassed > s.lastFeeCycle){
      s.monthlyfeespaid = 0; 
      s.lastFeeCycle = monthsPassed;
      const monthStr = `${today.getFullYear()}-${today.getMonth()+1}`;
      s.history.push({month:monthStr, paid:0});
    }
  });
  save();
}

/* ================= HELPERS ================= */
function hide(id){document.getElementById(id).classList.add("hidden")}
function show(id){document.getElementById(id).classList.remove("hidden")}
function download(blob,name){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=name; a.click();
}
</script>

</body>
</html>
